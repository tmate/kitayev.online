<!DOCTYPE html>
<!--suppress XmlDuplicatedId -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Моя Жизнь</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="icon" type="image/svg" href="images/favicon.svg">
    <link rel="stylesheet" href="css/life.css">

    <script src="js/birthdaypicker.js"></script>
    <script src="js/life.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-996777277">
    </script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'AW-996777277');
    </script>
</head>

<body>
    <div class="carousel non-touch">
        <div class="header">
            <p id="birthday_picker">
                <span>Я родился</span>
                <select id="day"></select><span>-го</span>
                <select id="month"></select>
                <select id="year"></select>
                <span>года.</span>
                <span>Вот</span>
                <select id="interval_picker">
                    <option value="year">годы</option>
                    <option value="month">месяцы</option>
                    <option value="week">недели</option>
                </select>
                <span>моей жизни.</span>
            </p>
        </div>
        <div class="viewport">
        </div>
        <div class="footer">
            <p>Что же я собираюсь с этим делать?</p>
        </div>
    </div>
    <div class="share non-touch">
        <img class="share-image" src="images/share.png" alt="Поделиться" title="Поделиться"/>
    </div>

    <div class="carousel touch">
        <div class="header page">
            <p id="birthday_picker">
                <span>Я родился</span>
                <select id="day"></select><span>-го</span>
                <select id="month"></select>
                <select id="year"></select>
                <span>года.</span>
            </p>
            <p>
                <span>Вот</span>
                <select id="interval_picker">
                    <option value="year">годы</option>
                    <option value="month">месяцы</option>
                    <option value="week">недели</option>
                </select>
                <span>моей жизни:</span>
            </p>
            <p style="color: #555555; align-self: center; font-size: 80%">крути&nbsp;вправо</p>
            <div class="share">
                <img class="share-image" src="images/share.png" alt="share"/>
            </div>
        </div>

        <div class="content page">
            <div class="viewport"></div>
        </div>

        <div class="footer page">
            <p>Что же я собираюсь с этим делать?</p>
            <a href="/" title="consider therapy">
                <svg width="130" height="130">
                    <image xlink:href="images/heart.svg" />
                </svg>
            </a>
            <div class="share">
                <img class="share-image" src="images/share.png" alt="share"/>
            </div>
        </div>
    </div>
    <div class="touch dots" id="dots"></div>

    <script>
        for (const el of document.getElementsByClassName("carousel")) {
            if (!el.checkVisibility()) {
                el.remove();
            }
        }

        function removeURLParam(key) {
            const url = new URL(window.location.href);
            url.searchParams.delete(key);
            window.history.replaceState({}, document.title, url.toString());
        }

        const urlSearchParams = new URLSearchParams(window.location.search);
        const urlBirthdate = urlSearchParams.get("date");
        const urlIntervalType = urlSearchParams.get("interval");
        if (urlBirthdate) {
            const [year, month, day] = urlBirthdate.split("-");
            if (year && month && day) {
                try {
                    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                    const age = new Date().getFullYear() - date.getFullYear();
                    if (age > 0 && age <= 84) {
                        localStorage.setItem("birthday", `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()}`);
                    }
                } catch {
                }
            }
        }
        if (urlIntervalType && ["month", "year", "week"].includes(urlIntervalType.toLowerCase())) {
            localStorage.setItem("interval", urlIntervalType);
        }

        removeURLParam("date");
        removeURLParam("interval");

        const SVG_NS = "http://www.w3.org/2000/svg";
        const birthdayPicker = new BirthdayPicker("#birthday_picker", {
            defaultDate: localStorage.getItem("birthday") || "1988-05-18",
            placeholder: false,
            leadingZero: false,
            yearEl: "#year",
            monthEl: "#month",
            dayEl: "#day",
            arrange: "dmy",
            locale: "ru",
            maxAge: 84
        });
        birthdayPicker.setMonthFormat("long");
        birthdayPicker.addEventListener("datechange", () => {
            adjustSelectsWidth();

            localStorage.setItem("birthday", birthdayPicker.getDateString("yyyy-mm-dd"));
            const event = new Event("life-update");
            window.dispatchEvent(event);
        });

        const picker = document.getElementById("interval_picker");
        picker.value = localStorage.getItem("interval") || "year";
        picker.addEventListener("change", () => {
            adjustSelectsWidth();
            localStorage.setItem("interval", picker.value);
            const event = new Event("life-update");
            window.dispatchEvent(event);
        });

        for (const btn of document.getElementsByClassName("share-image")) {
            btn.addEventListener("click", async () => {
                const sharedURL = new URL(window.location.href);
                sharedURL.searchParams.set("date", localStorage.getItem("birthday") || "1988-05-18");
                sharedURL.searchParams.set("interval", localStorage.getItem("interval") || "year");
                const shareData = {
                    url : sharedURL.toString(),
                    text: "Ваша жизнь с высоты птичьего полёта",
                    title: "Ваша жизнь"
                };

                if (navigator.share) {
                    try {
                        await navigator.share(shareData);
                    } catch {
                    }
                } else {
                    window.location.href = shareData.url;
                }
            });
        }

        function adjustMonthSelectsValues() {
            const monthForIndex = (index) => {
                return [
                    "января", "февраля", "марта",
                    "апреля", "мая", "июня",
                    "июля", "августа", "сентября",
                    "октября", "ноября", "декабря"
                ][index];
            };

            for (const select of document.getElementsByTagName("select")) {
                if (select.id === "month") {
                    for (let i = 0; i < select.options.length; i++) {
                        select.options[i].text = monthForIndex(i);
                    }
                }
            }
        }

        function adjustSelectsWidth() {
            for (const select of document.getElementsByTagName("select")) {
                const tempSpan = document.createElement("span");
                tempSpan.style.visibility = "hidden";
                tempSpan.style.fontWeight = "bold";
                tempSpan.innerText = select.options[select.selectedIndex].text;

                select.replaceWith(tempSpan);
                const width = tempSpan.getBoundingClientRect().width;
                select.style.maxWidth = `${width}px`;
                select.style.minWidth = `${width}px`;
                select.style.width = `${width}px`;

                tempSpan.replaceWith(select);
            }
        }

        function generate(birthDate, intervalType) {
            for (const viewport of document.getElementsByClassName("viewport")) {
                const svg = document.createElementNS(SVG_NS, "svg");

                const rect = viewport.getBoundingClientRect();
                const layout = life.generate(birthDate, intervalType, rect.width, rect.height);

                for (let index = 0; index < layout.items.length; index++) {
                    const child = life.render(layout, index);
                    if (child) {
                        svg.appendChild(life.render(layout, index));
                    }
                }

                if (viewport.firstChild) {
                    viewport.firstChild.replaceWith(svg);
                } else {
                    viewport.appendChild(svg);
                }
            }
        }

        function setupDots() {
            const carousel = document.getElementsByClassName("carousel")[0];
            const pages = carousel.querySelectorAll(".page");
            const dotsContainer = document.getElementById("dots");

            pages.forEach((_, i) => {
                const dot = document.createElement("button");
                dot.addEventListener("click", () => {
                    carousel.scrollTo({
                        left: i * window.innerWidth,
                        behavior: "smooth"
                    });
                });
                dotsContainer.appendChild(dot);
            });

            const dots = dotsContainer.querySelectorAll("button");
            function updateDots() {
                const index = Math.round(carousel.scrollLeft / window.innerWidth);
                dots.forEach((dot, i) => {
                    dot.classList.toggle("active", i === index);
                });
            }

            carousel.addEventListener("scroll", () => {
                requestAnimationFrame(updateDots);
            });
            updateDots();
        }

        adjustMonthSelectsValues();
        setupDots();

        let timeout;
        window.addEventListener("resize", () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const event = new Event("life-update");
                window.dispatchEvent(event);
            }, 50);
        });

        window.addEventListener("life-update", () => {
            adjustSelectsWidth();
            const dateOfBirth = localStorage.getItem("birthday") || "1988-05-18";
            const [year, month, day] = dateOfBirth.split("-");
            const birthDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            generate(birthDate , localStorage.getItem("interval") || "year");
        });

        const event = new Event("life-update");
        window.dispatchEvent(event);
    </script>
</body>
</html>