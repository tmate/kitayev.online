<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FOMO</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            background: #333;
        }
        .header {
            padding: 1em 1em 0;
        }
        .footer {
            padding: 0 1em 1em;
        }
        .footer p {
            margin: 0;
        }
        .header, .footer {
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .viewport {
            flex: 1;
            margin: 1em;
            min-width: 400px;
            min-height: 400px;
        }
        .viewport > * {
            width: 100%;
            height: 100%;
        }
        select {
            border: none;
            border-bottom: 1px #ccc dashed;
            background-color: transparent;
            outline: none; /* Removes the focus outline */
            padding: 0; /* Adjust as needed */
            cursor: pointer;
            margin-right: 4px; /* Adjust as needed */
            margin-left: 4px; /* Adjust as needed */
            font-family: inherit; /* Inherit font from parent */
            font-size: inherit; /* Inherit font size from parent */
            color: inherit; /* Inherit color from parent */
            box-shadow: none;
            -webkit-appearance: none; /* For consistent styling across browsers */
            overflow: hidden;

        }
        select option {
            overflow: hidden;
            color: #ccc;
            padding: 4px;
            background-color: #333; /* Example color */
        }
    </style>
    <script src="js/birthdaypicker.js"></script>
    <script src="js/fomo.js"></script>
</head>
<body>
    <div class="header">
        <div style="margin-right: 0.5em;">Birthday:</div>
        <div id="birthday_picker"></div>

        <label for="interval_picker" style="margin-left: 1em; margin-right: 0.5em;">Interval:</label>
        <select id="interval_picker">
            <option value="week">Weeks</option>
            <option value="month">Months</option>
        </select>

    </div>
    <div class="viewport"></div>
    <div class="footer">
        <p>&copy; 2025, Alexander Kitayev.</p>
    </div>

    <script>
        const SVG_NS = "http://www.w3.org/2000/svg";
        const birthdayPicker = new BirthdayPicker("#birthday_picker", {
            defaultDate: localStorage.getItem("birthday") || "now",
            placeholder: false
        });

        const intervalPicker = document.getElementById("interval_picker");
        defaultInterval = localStorage.getItem("interval") || "month";
        intervalPicker.value = defaultInterval;

        intervalPicker.addEventListener("change", () => {
            localStorage.setItem("interval", document.getElementById("interval_picker").value);
            const event = new Event("resize");
            window.dispatchEvent(event);
        });

        birthdayPicker.addEventListener("datechange", () => {
            localStorage.setItem("birthday", birthdayPicker.getDateString("yyyy-mm-dd"));
            const event = new Event("resize");
            window.dispatchEvent(event);
        });

        function reposition() {
            // noinspection JSUnresolvedReference
            const birthDate = birthdayPicker.getDateString("yyyy-mm-dd");
            const now = new Date();

            const intervalPicker = document.getElementById("interval_picker");
            const intervalType = intervalPicker.value;

            for (const viewport of document.getElementsByClassName("viewport")) {
                const svg = document.createElementNS(SVG_NS, "svg");

                const rect = viewport.getBoundingClientRect();
                let numberOfWeeks = 0;
                let currentWeek = 0;

                for(let w of fomo[`${intervalType}Intervals`](birthDate)) {
                    numberOfWeeks += 1;
                    if (w.contains(now)) {
                        currentWeek = w.index;
                    }
                }

                const layout = fomo.layout(rect.width, rect.height, numberOfWeeks);
                const s = Math.min(layout.width, layout.height);

                for (let w of fomo[`${intervalType}Intervals`](birthDate)) {

                    const radius = s / 2;
                    const x = (w.index % layout.cols) * layout.width;
                    const y = (Math.floor(w.index / layout.cols)) * layout.height;


                    if (currentWeek > w.index || currentWeek < w.index) {
                        const stroke = "#ccc";
                        const background = currentWeek > w.index ? "#333" : "#ccc";

                        const cx = x + radius;
                        const cy = y + radius;
                        const r = radius * .8;

                        const cell = document.createElementNS(SVG_NS, "circle");
                        cell.setAttribute("stroke", stroke);
                        cell.setAttribute("fill", background);
                        cell.setAttribute("cx", `${cx}`);
                        cell.setAttribute("cy", `${cy}`);
                        cell.setAttribute("r", `${r}`);
                        svg.appendChild(cell);
                    } else {
                        const color = "#E53935";

                        const g = document.createElementNS(SVG_NS, "g");
                        let xGap = 0;
                        let yGap = 0;

                        if (s === layout.width) {
                            yGap = Math.abs(layout.height - layout.width)/2;
                        } else {
                            xGap = Math.abs(layout.height - layout.width)/2;
                        }

                        g.setAttribute("transform", `translate(${x + xGap} ${y + yGap}) scale(${s/80}) `);

                        const heart = document.createElementNS(SVG_NS, "path");
                        heart.setAttribute("d",
                            "M 0,20 " +
                            "A 20,20 0,0,1 40,20 " +
                            "A 20,20 0,0,1 80,20 " +
                            "Q 80,50 40,80 " +
                            "Q 0,50 0,20 " +
                            "z");

                        heart.setAttribute("transform-origin", "40 40")
                        heart.setAttribute("fill", color);

                        const animation = document.createElementNS(SVG_NS, "animateTransform");
                        animation.setAttribute("attributeName", "transform");
                        animation.setAttribute("attributeType", "XML");
                        animation.setAttribute("type", "scale");
                        animation.setAttribute("values", "0.8;0.9;0.8;1;0.8;0.8");
                        animation.setAttribute("keyTimes", "0;0.1;0.2;0.35;0.45;1");
                        animation.setAttribute("dur", "4s");
                        animation.setAttribute("repeatCount", "indefinite");

                        heart.appendChild(animation);
                        g.appendChild(heart);
                        svg.appendChild(g);
                    }
                }

                if (viewport.firstChild) {
                    viewport.firstChild.replaceWith(svg);
                } else {
                    viewport.appendChild(svg);
                }
            }
        }

        let timeout;
        window.addEventListener("resize", () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                console.time("generate");
                reposition();
                console.timeEnd("generate");
            }, 50);
        });

        const event = new Event("resize");
        window.dispatchEvent(event);
    </script>
</body>
</html>