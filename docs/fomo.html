<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FOMO</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            background: #333;
        }
        .header {
            padding-right: 1em;
            padding-left: 1em;
            padding-top: 1em;
        }
        .footer {
            padding: 0 1em 1em;
        }
        .footer p {
            margin: 0;
        }
        .header, .footer {
            background: #333;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .viewport {
            flex: 1;
            margin: 1em;
            min-width: 400px;
            min-height: 400px;
        }
        .viewport > * {
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="https://unpkg.com/birthdaypicker"></script>
</head>
<body>
    <div class="header">
        <div id="birthday_picker"></div>
    </div>
    <div class="viewport"></div>
    <div class="footer">
        <p>&copy; 2025, Alexander Kitayev.</p>
    </div>

    <script>
        const SVG_NS = "http://www.w3.org/2000/svg";
        const birthdayPicker = new BirthdayPicker("#birthday_picker", {
            defaultDate: localStorage.getItem("birthday") || "now",
            placeholder: false
        });

        birthdayPicker.addEventListener("datechange", () => {
            const event = new Event("resize");
            localStorage.setItem("birthday", birthdayPicker.getDateString("yyyy-mm-dd"));
            window.dispatchEvent(event);
        });

        function weeksSince(dateStr) {
            const pastDate = new Date(dateStr);
            const now = new Date();
            const diffMs = now - pastDate;
            const msInWeek = 1000 * 60 * 60 * 24 * 7;
            const weeks = diffMs / msInWeek;

            return Math.floor(weeks);
        }

        const weeks = 52 * 69;

        const prevWeek = (date) => {
            const prev = new Date(date);
            prev.setDate(prev.getDate() - 7);
            return prev;
        };

        const nextWeek = (date) => {
            const next = new Date(date);
            next.setDate(next.getDate() + 7);
            return next;
        };

        function* cells(dateOfBirth, prev, next, options={}) {

            const {
                includeInception=true,
                includeBeforeInception=1,
                includeBeforeBirth=1,
                includeAfterDeath=2
            } = options;

            const [year, month, day] = dateOfBirth.split("-");
            const birthDate = new Date(year, month - 1, day);
            const currentDate = new Date();
            const inceptionDate = new Date(birthDate);
            inceptionDate.setDate(birthDate.getDate() - 280);
            const deathDate =  new Date(birthDate);
            deathDate.setFullYear(birthDate.getFullYear() + 69);

            let date = prev(inceptionDate);
            while(true) {
                const end = next(date);
                yield {
                    start: date,
                    end: end,
                    isBeforeInception: date.getTime() < inceptionDate.getTime(),
                    isBeforeBirth: date.getTime() < birthDate.getTime(),
                    isAfterDeath: date.getTime() > deathDate.getTime(),
                    isNow: date.getTime() <= currentDate.getTime() && end.getTime() > currentDate.getTime(),
                };
                date = end;
            }
        }

        let count = 0;
        for(const c of cells("1977-10-19", prevWeek, nextWeek)) {
            if (c.isAfterDeath) {
                break;
            }
            count += 1;
        }

        console.log("weeks", count)

        function computeGradientColor(color1, color2, t) {
            const c1 = parseInt(color1.slice(1), 16);
            const c2 = parseInt(color2.slice(1), 16);

            const r1 = (c1 >> 16) & 0xff, g1 = (c1 >> 8) & 0xff, b1 = c1 & 0xff;
            const r2 = (c2 >> 16) & 0xff, g2 = (c2 >> 8) & 0xff, b2 = c2 & 0xff;

            const r = Math.round(r1 + (r2 - r1) * t);
            const g = Math.round(g1 + (g2 - g1) * t);
            const b = Math.round(b1 + (b2 - b1) * t);

            return `rgb(${r}, ${g}, ${b})`;
        }

        function computeCellSize(width, height, cells) {
            let cols = 1;
            while(true) {
                const cellSize = width / cols;
                const rows = Math.ceil(cells / cols);
                if (rows * cellSize < height) {
                    return {
                        rows : rows,
                        cols: cols,
                        cellSize: cellSize,
                        cells: cells
                    };
                }
                cols += 1;
            }
        }

        function reposition() {
            const currentWeek = weeksSince(birthdayPicker.getDateString("yyyy-mm-dd"));

            for (const viewport of document.getElementsByClassName("viewport")) {
                const svg = document.createElementNS(SVG_NS, "svg");

                const rect = viewport.getBoundingClientRect();
                const grid = computeCellSize(rect.width, rect.height, weeks);
                const radius = grid.cellSize / 2;

                for (let i = 0; i < weeks; i++) {
                    const cell = document.createElementNS(SVG_NS, "circle");

                    const cx = (i % grid.cols)*grid.cellSize + radius;
                    const cy = (Math.floor(i / grid.cols))*grid.cellSize + radius;
                    const r = radius * .85;

                    cell.setAttribute("cx", `${cx}`);
                    cell.setAttribute("cy", `${cy}`);
                    cell.setAttribute("r", `${r}`);

                    let background;
                    if (currentWeek < i) {
                        background = computeGradientColor("#00ff00", "#cccccc", (i - currentWeek)/(weeks - currentWeek));
                    } else if (currentWeek === i) {
                        background = "#ffa500";
                    } else {
                        background = computeGradientColor("#cccccc", "#ffa500", i/currentWeek);
                    }
                    cell.setAttribute("fill", background);
                    svg.appendChild(cell);
                }

                if (viewport.firstChild) {
                    viewport.firstChild.replaceWith(svg);
                } else {
                    viewport.appendChild(svg);
                }
            }
        }

        let timeout;
        window.addEventListener("resize", () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                console.time("generate");
                reposition();
                console.timeEnd("generate");
            }, 50);
        });

        const event = new Event("resize");
        window.dispatchEvent(event);
    </script>
</body>
</html>