<!DOCTYPE html>
<!--suppress XmlDuplicatedId -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Моя Жизнь</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="css/life.css">

    <script src="js/birthdaypicker.js"></script>
    <script src="js/life.js"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=AW-996777277">
    </script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'AW-996777277');
    </script>
</head>

<body>
    <div class="carousel non-touch">
        <div class="header">
            <p id="birthday_picker">
                <span>Я родился</span>
                <select id="day"></select><span>-го</span>
                <select id="month"></select>
                <select id="year"></select>
                <span>года.</span>
                <span>Вот</span>
                <select id="interval_picker">
                    <option value="year">годы</option>
                    <option value="month">месяцы</option>
                    <option value="week">недели</option>
                </select>
                <span>моей жизни.</span>
            </p>
        </div>
        <div class="viewport">
        </div>
        <div class="footer">
            <p>Что же я собираюсь с этим делать?</p>
        </div>
    </div>

    <div class="carousel touch">
        <div class="header page">
            <p id="birthday_picker">
                <span>Я родился</span>
                <select id="day"></select><span>-го</span>
                <select id="month"></select>
                <select id="year"></select>
                <span>года.</span>
            </p>
            <p>
                <span>Вот</span>
                <select id="interval_picker">
                    <option value="year">годы</option>
                    <option value="month">месяцы</option>
                    <option value="week">недели</option>
                </select>
                <span>моей жизни.</span>
            </p>
            <img alt="swipe right" src="images/swipe.png"/>
        </div>
        <div class="content page">
            <div class="viewport"></div>
            <div class="viewport-footer">
                <img alt="swipe right" src="images/swipe.png"/>
            </div>
        </div>
        <div class="footer page">
            <p>Что же я собираюсь с этим делать?</p>
            <a href="/">
                <img alt="consider therapy" src="images/heart.svg"/>
            </a>
        </div>
    </div>

    <script>
        for (const el of document.getElementsByClassName("carousel")) {
            if (!el.checkVisibility()) {
                el.remove();
            }
        }

        const SVG_NS = "http://www.w3.org/2000/svg";
        const birthdayPicker = new BirthdayPicker("#birthday_picker", {
            defaultDate: localStorage.getItem("birthday") || "1988-05-18",
            placeholder: false,
            leadingZero: false,
            yearEl: "#year",
            monthEl: "#month",
            dayEl: "#day",
            arrange: "dmy",
            locale: "ru"
        });
        birthdayPicker.setMonthFormat("long");
        birthdayPicker.addEventListener("datechange", () => {
            adjustSelectsWidth();

            localStorage.setItem("birthday", birthdayPicker.getDateString("yyyy-mm-dd"));
            const event = new Event("life-update");
            window.dispatchEvent(event);
        });

        const picker = document.getElementById("interval_picker");
        picker.value = localStorage.getItem("interval") || "year";
        picker.addEventListener("change", () => {
            adjustSelectsWidth();
            localStorage.setItem("interval", picker.value);
            const event = new Event("life-update");
            window.dispatchEvent(event);
        });

        function adjustMonthSelectsValues() {
            const monthForIndex = (index) => {
                return [
                    "января", "февраля", "марта",
                    "апреля", "мая", "июня",
                    "июля", "августа", "сентября",
                    "октября", "ноября", "декабря"
                ][index];
            };

            for (const select of document.getElementsByTagName("select")) {
                if (select.id === "month") {
                    for (let i = 0; i < select.options.length; i++) {
                        select.options[i].text = monthForIndex(i);
                    }
                }
            }
        }

        function adjustSelectsWidth() {
            for (const select of document.getElementsByTagName("select")) {
                const tempSpan = document.createElement("span");
                tempSpan.style.visibility = "hidden";
                tempSpan.style.fontWeight = "bold";
                tempSpan.innerText = select.options[select.selectedIndex].text;

                select.replaceWith(tempSpan);
                const width = tempSpan.getBoundingClientRect().width;
                select.style.maxWidth = `${width}px`;
                select.style.minWidth = `${width}px`;
                select.style.width = `${width}px`;

                tempSpan.replaceWith(select);
            }
        }

        function generate(birthDate, intervalType) {
            for (const viewport of document.getElementsByClassName("viewport")) {
                const svg = document.createElementNS(SVG_NS, "svg");

                const rect = viewport.getBoundingClientRect();
                const layout = life.generate(birthDate, intervalType, rect.width, rect.height);
                console.log(layout);

                for (let index = 0; index < layout.items.length; index++) {
                    const child = life.render(layout, index);
                    if (child) {
                        svg.appendChild(life.render(layout, index));
                    }
                }

                if (viewport.firstChild) {
                    viewport.firstChild.replaceWith(svg);
                } else {
                    viewport.appendChild(svg);
                }
            }
        }

        adjustMonthSelectsValues();

        let timeout;
        window.addEventListener("resize", () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const event = new Event("life-update");
                window.dispatchEvent(event);
            }, 50);
        });

        window.addEventListener("life-update", () => {
            adjustSelectsWidth();
            const dateOfBirth = localStorage.getItem("birthday") || "1988-05-18";
            const [year, month, day] = dateOfBirth.split("-");
            const birthDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
            generate(birthDate , localStorage.getItem("interval") || "year");
        });

        const event = new Event("life-update");
        window.dispatchEvent(event);
    </script>
</body>
</html>